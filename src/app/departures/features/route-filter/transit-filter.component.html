<form [formGroup]="form">
  <h3 class="text-xl py-3">Search Departure Times by Route:</h3>
  <div class="w-full flex flex-col align-center">
    <mat-form-field appearance="fill">
      <mat-label>Select a route</mat-label>
      <mat-select name="route" [formControl]="transitRouteControl">
        <ng-container *ngIf="routes$ | async as routeList">
          <mat-option
            *ngFor="let route of routeList"
            [value]="route.transitRouteId"
          >
            {{ route.label }}
          </mat-option>
        </ng-container>
      </mat-select>
    </mat-form-field>
    <ng-container *ngIf="routeDirections$ | async as directions">
      <mat-form-field appearance="fill" *ngIf="directions && directions.length">
        <mat-label>Select a Direction</mat-label>
        <mat-select name="routeDirection" [formControl]="routeDirectionControl">
          <mat-option
            *ngFor="let direction of directions"
            [value]="direction.directionId"
          >
            {{ direction.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-container>
    <ng-container *ngIf="routeStopLocations$ | async as stops">
      <mat-form-field appearance="fill" *ngIf="stops && stops.length">
        <mat-label>Select Stop Location</mat-label>
        <mat-select
          name="stopLocation"
          [formControl]="routeStopLocationControl"
        >
          <mat-option
            *ngFor="let location of stops"
            [value]="location.placeCode"
          >
            {{ location.description }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-container>
  </div>
</form>

<ng-container
  *ngIf="
    this.transitRoute?.getDepatures(
      this.selectedDirection?.directionId!,
      this.selectedLocationStop?.placeCode!
    ) as locationDepartures
  "
>
  <ul>
    <li *ngFor="let item of locationDepartures">
      <h4 class="text-3xl flex flex-row justify-between">
        <span>{{ item.description }}</span>
        <span>Stop # {{ this.transitRoute?.stopLocationId }}</span>
      </h4>
      <div>
        <ng-container
          *ngIf="item.departures && item.departures?.length; else noDepartures"
        >
          <table mat-table [dataSource]="item.departures" class="w-full">
            <!--- Note that these columns can be defined in any order.
                  The actual rendered columns are set as a property on the row definition" -->

            <!-- Position Column -->
            <ng-container matColumnDef="routeName">
              <th mat-header-cell *matHeaderCellDef>Route</th>
              <td mat-cell *matCellDef="let departure">
                {{ departure.shortName }}
              </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="isRealTime">
              <th mat-header-cell *matHeaderCellDef>Is Real time</th>
              <td mat-cell *matCellDef="let departure">
                {{ departure.isRealTime ? '&#9745;' : '&#9746;' }}
              </td>
            </ng-container>

            <!-- Weight Column -->
            <ng-container matColumnDef="destination">
              <th mat-header-cell *matHeaderCellDef>Destination</th>
              <td mat-cell *matCellDef="let departure">
                {{ departure.destinationDescription }}
              </td>
            </ng-container>

            <ng-container matColumnDef="departureTime">
              <th mat-header-cell *matHeaderCellDef>Departure Time</th>
              <td mat-cell *matCellDef="let departure">
                {{ departure.departureTime.getTime() | date: 'shortTime' }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </ng-container>
        <ng-template #noDepartures>
          <div class="error-msg text-center py-3 w-full">
            <p class="text-gray-900 text-xl">
              There are no departures at the moment.
            </p>
            <p class="text-gray-700 text-lg">Please try again later.</p>
          </div>
        </ng-template>
      </div>
    </li>
  </ul>
</ng-container>
